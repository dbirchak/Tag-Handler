(function(a){var s={getSerializedTags:function(){return f(this,"tags").assignedTags.join(",")},getTags:function(){return f(this,"tags").assignedTags.slice()},getSerializedOptions:function(){var a=f(this,"tags");return a.availableTags.concat(a.assignedTags).join(",")},getOptions:function(){var a=f(this,"tags");return a.availableTags.concat(a.assignedTags)},addTag:function(c,b){var d=f(this,"opts");if(!d)return null;var e=f(this,"tags"),h=a(this).find(".tagInputField");if(!x(this,a.trim(c),b))return e; if(0<d.maxTags&&e.assignedTags.length>=d.maxTags)return alert(d.msgMaxTags+" "+d.maxTags),e;var g=1;"function"==typeof d.onAdd&&!b&&(g=d.onAdd.call(this,c));if("undefined"!=typeof g&&!1===g)return e;e.assignedTags.push(c);e.availableTags=a(this).tagHandler("removeOption",c);g=a('<li data-tag="'+c+'"></li>');a(g).addClass("tagItem");var j=a("<span>"+c+"</span>");d.jqueryTheme&&(a(g).addClass("ui-menu-item").addClass("ui-widget").addClass("ui-state-default").addClass("ui-button-text-only").addClass("ui-corner-all").addClass("ui-widget-content").addClass("jqueryUiTagItem").removeClass("tagItem"), a(j).addClass("ui-button-text"));a(g).append(j);a(g).insertBefore(a(h).parent());d.sortTags&&(e=q(e));d.autocomplete&&("function"==typeof a.fn.autocomplete&&d.allowEdit)&&a(this).find(".tagInputField").autocomplete("option","source",e.availableTags);k(this,"tags",e);""!==d.updateURL&&(d.autoUpdate&&!b)&&a(this).tagHandler("saveTags");"function"==typeof d.afterAdd&&!b&&d.afterAdd.call(this,c);return e},removeTag:function(c){var b=f(this,"opts");if(!b)return null;var d=f(this,"tags");a(this).find('[data-tag="'+ c+'"]').remove();a.each(d.assignedTags,function(a,b){b===c&&d.assignedTags.splice(a,1)});a(this).tagHandler("addOption",c);b.sortTags&&(d=q(d));b.autocomplete&&("function"==typeof a.fn.autocomplete&&b.allowEdit)&&a(this).find(".tagInputField").autocomplete("option","source",d.availableTags);k(this,"tags",d);return d},addOption:function(c){var b=f(this,"opts");if(!b)return null;var d=f(this,"tags"),e;e=a.trim(c);if(f(this,"opts")){var h=f(this,"tags");e=m(e,h,"assignedTags")||m(e,h,"availableTags")? !1:!0}else e=!1;if(!e)return d.availableTags;d.availableTags.push(c);b.sortTags&&(d=q(d));b.autocomplete&&("function"==typeof a.fn.autocomplete&&b.allowEdit)&&a(this).find(".tagInputField").autocomplete("option","source",d.availableTags);k(this,"tags",d);return d.availableTags},removeOption:function(c){var b=f(this,"opts");if(!b)return null;var d=f(this,"tags");a.each(d.availableTags,function(a,b){b===c&&d.availableTags.splice(a,1)});b.autocomplete&&("function"==typeof a.fn.autocomplete&&b.allowEdit)&& a(this).find(".tagInputField").autocomplete("option","source",d.availableTags);k(this,"tags",d);return d.availableTags},saveTags:function(){var c=f(this,"opts");if(c||c.updateURL){var b=f(this,"generatedId"),d=f(this,"tags"),e=a("#"+b+"_save"),h=a("#"+b+"_loader"),b={tags:d.assignedTags};a.extend(b,c.updateData);a.ajax({type:"POST",url:c.updateURL,cache:!1,data:b,dataType:"json",beforeSend:function(){e.length?a(e).fadeOut(200,function(){a(h).fadeIn(200)}):a(h).fadeIn(200)},complete:function(){a(h).fadeOut(200, function(){e.length&&a(e).fadeIn(200)})}})}},destroy:function(){var c=f(this,"original"),b=a(this).parent();a(b).replaceWith(c)},reload:function(){var c=f(this,"opts"),b=f(this,"original");c&&(a(this).tagHandler("destroy"),a(b).tagHandler(c))},version:function(){return"2.0.0-alpha"}},B=function(c){var b=a.extend({},v(),c);t(a(this),b);a(this).each(function(){if(a(this).is("ul")){k(this,"original",a(this).get(0).cloneNode(!0));a(this).find("li").each(function(){b.assignedTags.push(a(this).html()); a(this).remove()});k(this,"opts",b);k(this,"tags",{availableTags:[],originalTags:[],assignedTags:[]});this.id||(this.id="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var c=16*Math.random()|0;return("x"==a?c:c&3|8).toString(16)}));k(this,"generatedId",this.id);var c=f(this,"opts"),e=a(this);e.wrap('<div class="'+c.className+'" />');e.addClass(c.className+"Container");var h=a('<li class="tagInput"></li>');h.append('<input class="tagInputField" type="text" />');c.allowEdit&&e.append(h); var g=this,c=f(g,"opts");""!==c.updateURL&&(c.autoUpdate||a("<div></div>").attr({id:g.id+"_save",title:"Save Tags"}).addClass("tagUpdate").click(function(){a(g).tagHandler("saveTags")}).appendTo(a(g).parent()),a("<div />").attr({id:g.id+"_loader",title:"Saving Tags"}).addClass("tagLoader").appendTo(a(g).parent()));var j=this,l=f(j,"opts");if(l&&l.autocomplete&&"function"==typeof a.fn.autocomplete){var q=f(j,"tags"),c=null,c=l.initLoad?q.availableTags:l.getURL?function(){a.ajax({url:l.getURL,cache:!1, data:l.getData,dataType:"json",success:function(a){u(j,a)},error:function(a,c,b){t(a,{text:c,error:b});throw Error(l.msgError);}})}:[],e=a(j).find(".tagInputField");a(e).autocomplete({source:c,select:function(c,b){var d=a(this),e=a.trim(b.item.value);q=a(j).tagHandler("addTag",e);d.focus();d.val("");return!1},minLength:l.minChars})}var r=this,n=f(r,"opts");n&&(f(r,"tags"),""!==n.getURL&&n.initLoad?a.ajax({url:n.getURL,cache:!1,data:n.getData,dataType:"json",success:function(a){u(r,a);w(r)},error:function(a, c,b){t(a,{text:c,error:b});throw Error(n.msgError);}}):u(r,n));var m=f(this,"opts");if(m){var s=f(this,"tags"),p=a(this).find(".tagInputField");m.allowEdit&&(a(p).keypress(a(this),y),a(p).keydown(a(this),z),a(this).click(function(){a(p).focus();a(p).trigger("focus")}),a(p).focus(function(){""===a(p).val()&&(m.autocomplete&&"function"==typeof a.fn.autocomplete&&0<s.availableTags.length)&&a(p).autocomplete("search","")}),a(this).delegate("li.tagItem, li.jqueryUiTagItem","click",a(this),A))}"function"== typeof b.afterLoad&&(!b.getURL&&b.initLoad)&&w(this)}})},w=function(a){var b=f(a,"opts");b&&"function"==typeof b.afterLoad&&b.afterLoad.call(a)},A=function(c){c=c.data;var b=f(c,"opts");if(b){f(c,"tags");var d=a(this),e=1;"function"==typeof b.onDelete&&(e=b.onDelete.call(this,a.trim(d.text())));if(e||"undefined"==typeof e)a(c).tagHandler("removeTag",d.text()),""!==b.updateURL&&b.autoUpdate&&a(c).tagHandler("saveTags");"function"==typeof b.afterDelete&&b.afterDelete.call(this,a.trim(d.text()))}},y= function(c){var b=c.data,d=f(b,"opts");if(d){var e=f(b,"tags"),h=c.keyCode||c.which,g=a(this);if(13===h||44===h||9===h||h===d.delimiter.charCodeAt(0))c.preventDefault(),c.stopImmediatePropagation(),d.allowAdd?(0<d.maxTags&&e.assignedTags.length>=d.maxTags?alert(d.msgMaxTags+" "+d.maxTags):(c=a.trim(g.val()),a(b).tagHandler("addTag",c)),g.val(""),g.focus()):alert(d.msgNoNewTag)}},z=function(c){var b=c.data,d=f(b,"opts");if(d){var e=f(b,"tags"),h=c.keyCode||c.which,g=a(this);9===h&&(c.preventDefault(), c.stopImmediatePropagation());if(8===c.which&&""===g.val()){c=e.assignedTags.slice(-1)[0];e=1;"function"==typeof d.onDelete&&(e=d.onDelete.call(this,a.trim(c)));if(e||"undefined"==typeof e)a(b).tagHandler("removeTag",c),""!==d.updateURL&&d.autoUpdate&&a(b).tagHandler("saveTags");"function"==typeof d.afterDelete&&d.afterDelete.call(this,a.trim(c));g.focus()}}},u=function(c,b){a(b.availableTags).each(function(b,e){a(c).tagHandler("addOption",e)});a(b.assignedTags).each(function(b,e){a(c).tagHandler("addTag", e,!0)})},x=function(a,b,d){var e=f(a,"opts");if(!e)return!1;a=f(a,"tags");if(m(b,a,"assignedTags"))return!1;a=!0;"function"==typeof e.onIsValid&&!d&&(a=e.onIsValid.call(this,b));return a},m=function(a,b,d){var e=!1;jQuery.each(b[d],function(b,d){return d===a?(e=!0,!1):!0});return e},q=function(a){a.availableTags=a.availableTags.sort();a.assignedTags=a.assignedTags.sort();a.originalTags=a.originalTags.sort();return a},k=function(c,b,d){var e=a(c).data("tagHandlerState");e||(e={});e[b]=d;a(c).data("tagHandlerState", e)},f=function(c,b){var d=a(c).data("tagHandlerState");return!d||void 0==d[b]?null:d[b]},v=function(){return{allowEdit:!0,allowAdd:!0,assignedTags:[],autocomplete:!1,autoUpdate:!1,availableTags:[],className:"tagHandler",debug:!1,delimiter:"",getData:{},getURL:"",initLoad:!0,maxTags:0,minChars:0,msgNoNewTag:"You don't have permission to create a new tag.",msgError:"There was an error getting the tag list.",msgMaxTags:"Maximum tags allowed:",onAdd:{},onDelete:{},onIsValid:{},afterAdd:{},afterDelete:{}, queryname:"q",sortTags:!0,updateData:{},updateURL:"",jqueryTheme:!1}},t=function(a,b){b.debug&&(window.console&&window.console.log)&&(window.console.log(a),window.console.log(b),window.console.log(v()))};jQuery.fn.tagHandler=function(a){return"string"==typeof a&&s[a]?s[a].apply(this,Array.prototype.slice.call(arguments,1)):B.apply(this,arguments)}})(jQuery);