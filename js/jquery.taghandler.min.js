(function($){var methods={getSerializedTags:function(){var tags=_getData(this,'tags');return tags.assignedTags.join(',')},getTags:function(){var tags=_getData(this,'tags');return tags.assignedTags},addTag:function(value){var opts=_getData(this,'opts');if(!opts){return null}var tags=_getData(this,'tags');var tagField=$(this).find(".tagInputField");tags.assignedTags.push(value);tags.availableTags=$(this).tagHandler('removeOption',value);$('<li data-tag="'+value+'">'+value+'</li>').addClass("tagItem").insertBefore($(tagField).parent());if(opts.sortTags){tags=_sortTags(tags)}if(opts.autocomplete&&typeof($.fn.autocomplete)=='function'&&opts.allowEdit){$(this).find(".tagInputField").autocomplete("option","source",tags.availableTags)}_saveData(this,'tags',tags);return tags},removeTag:function(value){var opts=_getData(this,'opts');if(!opts){return null}var tags=_getData(this,'tags');$(this).find('[data-tag="'+value+'"]').remove();$.each(tags.assignedTags,function(i,e){if(e===value){tags.assignedTags.splice(i,1)}});tags.availableTags.push(value);if(opts.sortTags){tags=_sortTags(tags)}if(opts.autocomplete&&typeof($.fn.autocomplete)=='function'&&opts.allowEdit){$(this).find(".tagInputField").autocomplete("option","source",tags.availableTags)}_saveData(this,'tags',tags);return tags},removeOption:function(value){var tags=_getData(this,'tags');$.each(tags.availableTags,function(i,e){if(e===value){tags.availableTags.splice(i,1)}});_saveData(this,'tags',tags);return tags.availableTags},addOption:function(value){var opts=_getData(this,'opts');if(!opts){return null}var tags=_getData(this,'tags');tags.availableTags.push(value);if(opts.sortTags){tags=_sortTags(tags)}if(opts.autocomplete&&typeof($.fn.autocomplete)=='function'&&opts.allowEdit){$(this).find(".tagInputField").autocomplete("option","source",tags.availableTags)}_saveData(this,'tags',tags);return tags.availableTags},saveTags:function(){var opts=_getData(this,'opts');if(!opts&&!opts.updateURL){return}var tags=_getData(this,'tags');var saveContainer=$("#"+this.id+"_save");var loadContainer=$("#"+this.id+"_loader");var sendData={tags:tags.assignedTags};$.extend(sendData,opts.updateData);$.ajax({type:'POST',url:opts.updateURL,cache:false,data:sendData,dataType:'json',beforeSend:function(){if(saveContainer.length){$(saveContainer).fadeOut(200,function(){$(loadContainer).fadeIn(200)})}else{$(loadContainer).fadeIn(200)}},complete:function(){$(loadContainer).fadeOut(200,function(){if(saveContainer.length){$(saveContainer).fadeIn(200)}})}})},destroy:function(){var original=_getData(this,'original');var parent=$(this).parent();$(parent).replaceWith(original)},reload:function(){var opts=_getData(this,'opts');var original=_getData(this,'original');if(!opts){return}$(this).tagHandler('destroy');$(original).tagHandler(opts)},version:function(){return"2.0.0-alpha"}};var _initTagHandler=function(options){var initialOpts=$.extend({},_getDefaults(),options);_debug($(this),initialOpts);$(this).each(function(){if(!$(this).is('ul')){return}_saveData(this,'original',$(this).get(0).cloneNode(true));_saveData(this,'opts',initialOpts);_saveData(this,'tags',{availableTags:[],originalTags:[],assignedTags:[]});if($(this).id){$(this).id=_generateUUID()}_saveData(this,'generatedId',$(this).id);_addTaggerWrappers(this);_addSaveAndLoaderDivs(this);_initAutoLoad(this);_initInitialTags(this);_initBinds(this)})};var _addTaggerWrappers=function(tagContainer){var opts=_getData(tagContainer,'opts');var tagContainerObject=$(tagContainer);tagContainerObject.wrap('<div class="'+opts.className+'" />');tagContainerObject.addClass(opts.className+"Container");var inputField=$('<li class="tagInput"></li>');inputField.append('<input class="tagInputField" type="text" />');if(opts.allowEdit){tagContainerObject.append(inputField)}};var _addSaveAndLoaderDivs=function(tagContainer){var opts=_getData(tagContainer,'opts');if(opts.updateURL!==''){if(!opts.autoUpdate){$("<div></div>").attr({id:tagContainer.id+"_save",title:"Save Tags"}).addClass("tagUpdate").click(function(){$(tagContainer).tagHandler('saveTags')}).appendTo($(tagContainer).parent())}$("<div />").attr({id:tagContainer.id+"_loader",title:"Saving Tags"}).addClass("tagLoader").appendTo($(tagContainer).parent())}};var _initAutoLoad=function(tagContainer){var opts=_getData(tagContainer,'opts');if(!opts||!opts.autocomplete||typeof($.fn.autocomplete)!='function'){return}var tags=_getData(tagContainer,'tags');var source=null;if(opts.initLoad){source=tags.availableTags}else{source=[]}var inputField=$(tagContainer).find(".tagInputField");$(inputField).autocomplete({source:source,select:function(event,ui){var $el=$(this);if(!_checkTag($.trim(ui.item.value),tags.assignedTags)){if(opts.maxTags>0&&tags.assignedTags.length>=opts.maxTags){throw new Error('Maximum tags allowed: '+opts.maxTags)}else{var newTag=$.trim(ui.item.value);var rc=1;if(typeof(opts.onAdd)=="function"){rc=opts.onAdd.call(this,newTag)}if(rc||typeof(rc)=="undefined"){tags=$(tagContainer).tagHandler('addTag',newTag);if(opts.updateURL!==''&&opts.autoUpdate){$(tagContainer).tagHandler('saveTags')}if(typeof(opts.afterAdd)=="function"){opts.afterAdd.call(this,newTag)}}}$el.focus()}$el.val("");return false},minLength:opts.minChars})};var _initInitialTags=function(tagContainer){var opts=_getData(tagContainer,'opts');if(!opts){return}var tags=_getData(tagContainer,'tags');if(opts.getURL!==''&&opts.initLoad){$.ajax({url:opts.getURL,cache:false,data:opts.getData,dataType:'json',success:function(data){_processTags(tagContainer,data)},error:function(xhr,text,error){_debug(xhr,{text:text,error:error});throw new Error(opts.msgError)}})}else{_processTags(tagContainer,opts)}};var _initBinds=function(tagContainer){var opts=_getData(tagContainer,'opts');if(!opts){return}var tags=_getData(tagContainer,'tags');var inputField=$(tagContainer).find(".tagInputField");if(opts.allowEdit){$(inputField).keypress($(tagContainer),_tagKeyPressHandler);$(inputField).keydown($(tagContainer),_tagKeyDownHandler);$(tagContainer).click(function(){$(inputField).focus();$(inputField).trigger('focus')});$(inputField).focus(function(){if($(inputField).val()===''&&opts.autocomplete&&typeof($.fn.autocomplete)=='function'&&opts.initLoad&&tags.availableTags.length>0){$(inputField).autocomplete("search","")}});$(tagContainer).delegate("li.tagItem","click",$(tagContainer),_tagClickHandler)}};var _tagClickHandler=function(e){var tagContainer=e.data;var opts=_getData(tagContainer,'opts');if(!opts){return}var tags=_getData(tagContainer,'tags');var $el=$(this);var rc=1;if(typeof(opts.onDelete)=="function"){rc=opts.onDelete.call(this,$.trim($el.text()))}if(rc){$(tagContainer).tagHandler('removeTag',$el.text());if(opts.updateURL!==''&&opts.autoUpdate){$(tagContainer).tagHandler('saveTags')}}if(typeof(opts.afterDelete)=="function"){opts.afterDelete.call(this,$.trim($el.text()))}};var _tagKeyPressHandler=function(e){var tagContainer=e.data;var opts=_getData(tagContainer,'opts');if(!opts){return}var tags=_getData(tagContainer,'tags');var keyCode=e.keyCode||e.which;var $el=$(this);if(keyCode===13||keyCode===44||keyCode===9||keyCode===opts.delimiter.charCodeAt(0)){e.preventDefault();e.stopImmediatePropagation();if($el.val()!==""&&!_checkTag($.trim($el.val()),tags.assignedTags)){if(!opts.allowAdd&&!_checkTag($.trim($el.val()),tags.availableTags)){alert(opts.msgNoNewTag);return}if(opts.maxTags>0&&tags.assignedTags.length>=opts.maxTags){alert('Maximum tags allowed: '+opts.maxTags)}else{var newTag=$.trim($el.val());var rc=1;if(typeof(opts.onAdd)=="function"){rc=opts.onAdd.call(this,newTag)}if(rc||typeof(rc)=="undefined"){tags=$(tagContainer).tagHandler('addTag',newTag);if(opts.updateURL!==''&&opts.autoUpdate){$(tagContainer).tagHandler('saveTags')}if(typeof(opts.afterAdd)=="function"){opts.afterAdd.call(this,newTag)}}}$el.val("");$el.focus()}}};var _tagKeyDownHandler=function(e){var tagContainer=e.data;var opts=_getData(tagContainer,'opts');if(!opts){return}var tags=_getData(tagContainer,'tags');var keyCode=e.keyCode||e.which;var $el=$(this);if(keyCode===9){e.preventDefault();e.stopImmediatePropagation()}if(e.which===8&&$el.val()===""){var deleted_tag=tags.assignedTags.slice(-1)[0];if(typeof(opts.onDelete)=="function"){opts.onDelete.call(this,$.trim(deleted_tag))}$(tagContainer).tagHandler('removeTag',deleted_tag);if(opts.updateURL!==''&&opts.autoUpdate){$(tagContainer).tagHandler('saveTags')}if(typeof(opts.afterDelete)=="function"){opts.afterDelete.call(this,$.trim(deleted_tag))}$el.focus()}};var _processTags=function(tagContainer,tagsToAdd){$(tagsToAdd.availableTags).each(function(i,e){$(tagContainer).tagHandler('addOption',e)});$(tagsToAdd.assignedTags).each(function(i,e){$(tagContainer).tagHandler('addTag',e)})};var _checkTag=function(value,tags){var check=false;jQuery.each(tags,function(i,e){if(e===value){check=true;return false}return true});return check};var _sortTags=function(tags){tags.availableTags=tags.availableTags.sort();tags.assignedTags=tags.assignedTags.sort();tags.originalTags=tags.originalTags.sort();return tags};var _saveData=function(container,keyName,saveData){var data=$(container).data('tagHandlerState');if(!data){data={}}data[keyName]=saveData;$(container).data('tagHandlerState',data)};var _getData=function(container,keyName){var data=$(container).data('tagHandlerState');if(!data||data[keyName]==undefined){return null}return data[keyName]};var _getDefaults=function(){return{allowEdit:true,allowAdd:true,assignedTags:[],autocomplete:false,autoUpdate:false,availableTags:[],className:'tagHandler',debug:false,delimiter:'',getData:{},getURL:'',initLoad:true,maxTags:0,minChars:0,msgNoNewTag:"You don't have permission to create a new tag.",msgError:"There was an error getting the tag list.",onAdd:{},onDelete:{},afterAdd:{},afterDelete:{},queryname:'q',sortTags:true,updateData:{},updateURL:''}};var _debug=function(tagContainer,options){if(options.debug&&window.console&&window.console.log){window.console.log(tagContainer);window.console.log(options);window.console.log($.fn.tagHandler.defaults)}};var _generateUUID=function(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16)})};jQuery.fn.tagHandler=function(options){if(typeof(options)=="string"&&methods[options]){return methods[options].apply(this,Array.prototype.slice.call(arguments,1))}else{return _initTagHandler.apply(this,arguments)}}})(jQuery);