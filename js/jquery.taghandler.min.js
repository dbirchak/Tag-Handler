(function(a){var q={getSerializedTags:function(){return f(this,"tags").assignedTags.join(",")},getTags:function(){return f(this,"tags").assignedTags},getSerializedOptions:function(){var a=f(this,"tags");return a.availableTags.concat(a.assignedTags).join(",")},getOptions:function(){var a=f(this,"tags");return a.availableTags.concat(a.assignedTags)},addTag:function(b,d){var c=f(this,"opts");if(!c)return null;var e=f(this,"tags"),h=a(this).find(".tagInputField");if(!w(this,a.trim(b),d))return e;if(0< c.maxTags&&e.assignedTags.length>=c.maxTags)return alert(c.msgMaxTags+" "+c.maxTags),e;var g=1;"function"==typeof c.onAdd&&!d&&(g=c.onAdd.call(this,b));if("undefined"!=typeof g&&!1===g)return e;e.assignedTags.push(b);e.availableTags=a(this).tagHandler("removeOption",b);g=a('<li data-tag="'+b+'"></li>');a(g).addClass("tagItem");var j=a("<span>"+b+"</span>");c.jqueryTheme&&(a(g).addClass("ui-menu-item").addClass("ui-widget").addClass("ui-state-default").addClass("ui-button-text-only").addClass("ui-corner-all").addClass("ui-widget-content").addClass("jqueryUiTagItem").removeClass("tagItem"), a(j).addClass("ui-button-text"));a(g).append(j);a(g).insertBefore(a(h).parent());c.sortTags&&(e=p(e));c.autocomplete&&("function"==typeof a.fn.autocomplete&&c.allowEdit)&&a(this).find(".tagInputField").autocomplete("option","source",e.availableTags);k(this,"tags",e);""!==c.updateURL&&(c.autoUpdate&&!d)&&a(this).tagHandler("saveTags");"function"==typeof c.afterAdd&&!d&&c.afterAdd.call(this,b);return e},removeTag:function(b){var d=f(this,"opts");if(!d)return null;var c=f(this,"tags");a(this).find('[data-tag="'+ b+'"]').remove();a.each(c.assignedTags,function(a,d){d===b&&c.assignedTags.splice(a,1)});c.availableTags.push(b);d.sortTags&&(c=p(c));d.autocomplete&&("function"==typeof a.fn.autocomplete&&d.allowEdit)&&a(this).find(".tagInputField").autocomplete("option","source",c.availableTags);k(this,"tags",c);return c},addOption:function(b){var d=f(this,"opts");if(!d)return null;var c=f(this,"tags");c.availableTags.push(b);d.sortTags&&(c=p(c));d.autocomplete&&("function"==typeof a.fn.autocomplete&&d.allowEdit)&& a(this).find(".tagInputField").autocomplete("option","source",c.availableTags);k(this,"tags",c);return c.availableTags},removeOption:function(b){var d=f(this,"opts");if(!d)return null;var c=f(this,"tags");a.each(c.availableTags,function(a,d){d===b&&c.availableTags.splice(a,1)});d.autocomplete&&("function"==typeof a.fn.autocomplete&&d.allowEdit)&&a(this).find(".tagInputField").autocomplete("option","source",c.availableTags);k(this,"tags",c);return c.availableTags},saveTags:function(){var b=f(this, "opts");if(b||b.updateURL){var d=f(this,"generatedId"),c=f(this,"tags"),e=a("#"+d+"_save"),h=a("#"+d+"_loader"),d={tags:c.assignedTags};a.extend(d,b.updateData);a.ajax({type:"POST",url:b.updateURL,cache:!1,data:d,dataType:"json",beforeSend:function(){e.length?a(e).fadeOut(200,function(){a(h).fadeIn(200)}):a(h).fadeIn(200)},complete:function(){a(h).fadeOut(200,function(){e.length&&a(e).fadeIn(200)})}})}},destroy:function(){var b=f(this,"original"),d=a(this).parent();a(d).replaceWith(b)},reload:function(){var b= f(this,"opts"),d=f(this,"original");b&&(a(this).tagHandler("destroy"),a(d).tagHandler(b))},version:function(){return"2.0.0-alpha"}},A=function(b){var d=a.extend({},v(),b);s(a(this),d);a(this).each(function(){if(a(this).is("ul")){k(this,"original",a(this).get(0).cloneNode(!0));a(this).find("li").each(function(){d.assignedTags.push(a(this).html());a(this).remove()});k(this,"opts",d);k(this,"tags",{availableTags:[],originalTags:[],assignedTags:[]});this.id||(this.id="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)}));k(this,"generatedId",this.id);var b=f(this,"opts"),e=a(this);e.wrap('<div class="'+b.className+'" />');e.addClass(b.className+"Container");var h=a('<li class="tagInput"></li>');h.append('<input class="tagInputField" type="text" />');b.allowEdit&&e.append(h);var g=this,b=f(g,"opts");""!==b.updateURL&&(b.autoUpdate||a("<div></div>").attr({id:g.id+"_save",title:"Save Tags"}).addClass("tagUpdate").click(function(){a(g).tagHandler("saveTags")}).appendTo(a(g).parent()), a("<div />").attr({id:g.id+"_loader",title:"Saving Tags"}).addClass("tagLoader").appendTo(a(g).parent()));var j=this,l=f(j,"opts");if(l&&l.autocomplete&&"function"==typeof a.fn.autocomplete){var p=f(j,"tags"),b=null,b=l.initLoad?p.availableTags:l.getURL?function(){a.ajax({url:l.getURL,cache:!1,data:l.getData,dataType:"json",success:function(a){t(j,a)},error:function(a,b,c){s(a,{text:b,error:c});throw Error(l.msgError);}})}:[],e=a(j).find(".tagInputField");a(e).autocomplete({source:b,select:function(b, c){var d=a(this),e=a.trim(c.item.value);p=a(j).tagHandler("addTag",e);d.focus();d.val("");return!1},minLength:l.minChars})}var r=this,m=f(r,"opts");m&&(f(r,"tags"),""!==m.getURL&&m.initLoad?a.ajax({url:m.getURL,cache:!1,data:m.getData,dataType:"json",success:function(a){t(r,a)},error:function(a,b,c){s(a,{text:b,error:c});throw Error(m.msgError);}}):t(r,m));var u=f(this,"opts");if(u){var q=f(this,"tags"),n=a(this).find(".tagInputField");u.allowEdit&&(a(n).keypress(a(this),x),a(n).keydown(a(this),y), a(this).click(function(){a(n).focus();a(n).trigger("focus")}),a(n).focus(function(){""===a(n).val()&&(u.autocomplete&&"function"==typeof a.fn.autocomplete&&0<q.availableTags.length)&&a(n).autocomplete("search","")}),a(this).delegate("li.tagItem, li.jqueryUiTagItem","click",a(this),z))}}})},z=function(b){b=b.data;var d=f(b,"opts");if(d){f(b,"tags");var c=a(this),e=1;"function"==typeof d.onDelete&&(e=d.onDelete.call(this,a.trim(c.text())));if(e||"undefined"==typeof e)a(b).tagHandler("removeTag",c.text()), ""!==d.updateURL&&d.autoUpdate&&a(b).tagHandler("saveTags");"function"==typeof d.afterDelete&&d.afterDelete.call(this,a.trim(c.text()))}},x=function(b){var d=b.data,c=f(d,"opts");if(c){var e=f(d,"tags"),h=b.keyCode||b.which,g=a(this);if(13===h||44===h||9===h||h===c.delimiter.charCodeAt(0))b.preventDefault(),b.stopImmediatePropagation(),c.allowAdd?(0<c.maxTags&&e.assignedTags.length>=c.maxTags?alert(c.msgMaxTags+" "+c.maxTags):(b=a.trim(g.val()),a(d).tagHandler("addTag",b)),g.val(""),g.focus()):alert(c.msgNoNewTag)}}, y=function(b){var d=b.data,c=f(d,"opts");if(c){var e=f(d,"tags"),h=b.keyCode||b.which,g=a(this);9===h&&(b.preventDefault(),b.stopImmediatePropagation());8===b.which&&""===g.val()&&(b=e.assignedTags.slice(-1)[0],"function"==typeof c.onDelete&&c.onDelete.call(this,a.trim(b)),a(d).tagHandler("removeTag",b),""!==c.updateURL&&c.autoUpdate&&a(d).tagHandler("saveTags"),"function"==typeof c.afterDelete&&c.afterDelete.call(this,a.trim(b)),g.focus())}},t=function(b,d){a(d.availableTags).each(function(c,d){a(b).tagHandler("addOption", d)});a(d.assignedTags).each(function(c,d){a(b).tagHandler("addTag",d,!0)})},w=function(a,d,c){var e=f(a,"opts");if(!e)return!1;a=f(a,"tags");var h=!0;jQuery.each(a.assignedTags,function(a,b){return b===d?h=!1:!0});"function"==typeof e.onIsValid&&!c&&(h=e.onIsValid.call(this,d));return h},p=function(a){a.availableTags=a.availableTags.sort();a.assignedTags=a.assignedTags.sort();a.originalTags=a.originalTags.sort();return a},k=function(b,d,c){var e=a(b).data("tagHandlerState");e||(e={});e[d]=c;a(b).data("tagHandlerState", e)},f=function(b,d){var c=a(b).data("tagHandlerState");return!c||void 0==c[d]?null:c[d]},v=function(){return{allowEdit:!0,allowAdd:!0,assignedTags:[],autocomplete:!1,autoUpdate:!1,availableTags:[],className:"tagHandler",debug:!1,delimiter:"",getData:{},getURL:"",initLoad:!0,maxTags:0,minChars:0,msgNoNewTag:"You don't have permission to create a new tag.",msgError:"There was an error getting the tag list.",msgMaxTags:"Maximum tags allowed:",onAdd:{},onDelete:{},onIsValid:{},afterAdd:{},afterDelete:{}, queryname:"q",sortTags:!0,updateData:{},updateURL:"",jqueryTheme:!1}},s=function(a,d){d.debug&&(window.console&&window.console.log)&&(window.console.log(a),window.console.log(d),window.console.log(v()))};jQuery.fn.tagHandler=function(a){return"string"==typeof a&&q[a]?q[a].apply(this,Array.prototype.slice.call(arguments,1)):A.apply(this,arguments)}})(jQuery);