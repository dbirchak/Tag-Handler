(function(e){var t={getSerializedTags:function(){var e=v(this,"tags");return e.assignedTags.join(",")},getTags:function(){var e=v(this,"tags");return e.assignedTags},addTag:function(t){var n=v(this,"opts");if(!n){return null}var r=v(this,"tags");var i=e(this).find(".tagInputField");r.assignedTags.push(t);r.availableTags=e(this).tagHandler("removeOption",t);var s=e('<li data-tag="'+t+'"></li>');e(s).addClass("tagItem");var o=e("<span>"+t+"</span>");if(n.jqueryTheme){e(s).addClass("ui-menu-item").addClass("ui-widget").addClass("ui-state-default").addClass("ui-button-text-only").addClass("ui-corner-all").addClass("ui-widget-content").addClass("jqueryUiTagItem").removeClass("tagItem");e(o).addClass("ui-button-text")}e(s).append(o);e(s).insertBefore(e(i).parent());if(n.sortTags){r=p(r)}if(n.autocomplete&&typeof e.fn.autocomplete=="function"&&n.allowEdit){e(this).find(".tagInputField").autocomplete("option","source",r.availableTags)}d(this,"tags",r);return r},removeTag:function(t){var n=v(this,"opts");if(!n){return null}var r=v(this,"tags");e(this).find('[data-tag="'+t+'"]').remove();e.each(r.assignedTags,function(e,n){if(n===t){r.assignedTags.splice(e,1)}});r.availableTags.push(t);if(n.sortTags){r=p(r)}if(n.autocomplete&&typeof e.fn.autocomplete=="function"&&n.allowEdit){e(this).find(".tagInputField").autocomplete("option","source",r.availableTags)}d(this,"tags",r);return r},removeOption:function(t){var n=v(this,"opts");if(!n){return null}var r=v(this,"tags");e.each(r.availableTags,function(e,n){if(n===t){r.availableTags.splice(e,1)}});if(n.autocomplete&&typeof e.fn.autocomplete=="function"&&n.allowEdit){e(this).find(".tagInputField").autocomplete("option","source",r.availableTags)}d(this,"tags",r);return r.availableTags},addOption:function(t){var n=v(this,"opts");if(!n){return null}var r=v(this,"tags");r.availableTags.push(t);if(n.sortTags){r=p(r)}if(n.autocomplete&&typeof e.fn.autocomplete=="function"&&n.allowEdit){e(this).find(".tagInputField").autocomplete("option","source",r.availableTags)}d(this,"tags",r);return r.availableTags},saveTags:function(){var t=v(this,"opts");if(!t&&!t.updateURL){return}var n=v(this,"tags");var r=e("#"+this.id+"_save");var i=e("#"+this.id+"_loader");var s={tags:n.assignedTags};e.extend(s,t.updateData);e.ajax({type:"POST",url:t.updateURL,cache:false,data:s,dataType:"json",beforeSend:function(){if(r.length){e(r).fadeOut(200,function(){e(i).fadeIn(200)})}else{e(i).fadeIn(200)}},complete:function(){e(i).fadeOut(200,function(){if(r.length){e(r).fadeIn(200)}})}})},destroy:function(){var t=v(this,"original");var n=e(this).parent();e(n).replaceWith(t)},reload:function(){var t=v(this,"opts");var n=v(this,"original");if(!t){return}e(this).tagHandler("destroy");e(n).tagHandler(t)},version:function(){return"2.0.0-alpha"}};var n=function(t){var n=e.extend({},m(),t);g(e(this),n);e(this).each(function(){if(!e(this).is("ul")){return}d(this,"original",e(this).get(0).cloneNode(true));d(this,"opts",n);d(this,"tags",{availableTags:[],originalTags:[],assignedTags:[]});if(e(this).id){e(this).id=y()}d(this,"generatedId",e(this).id);r(this);i(this);s(this);o(this);u(this)})};var r=function(t){var n=v(t,"opts");var r=e(t);r.wrap('<div class="'+n.className+'" />');r.addClass(n.className+"Container");var i=e('<li class="tagInput"></li>');i.append('<input class="tagInputField" type="text" />');if(n.allowEdit){r.append(i)}};var i=function(t){var n=v(t,"opts");if(n.updateURL!==""){if(!n.autoUpdate){e("<div></div>").attr({id:t.id+"_save",title:"Save Tags"}).addClass("tagUpdate").click(function(){e(t).tagHandler("saveTags")}).appendTo(e(t).parent())}e("<div />").attr({id:t.id+"_loader",title:"Saving Tags"}).addClass("tagLoader").appendTo(e(t).parent())}};var s=function(t){var n=v(t,"opts");if(!n||!n.autocomplete||typeof e.fn.autocomplete!="function"){return}var r=v(t,"tags");var i=null;if(n.initLoad){i=r.availableTags}else{i=[]}var s=e(t).find(".tagInputField");e(s).autocomplete({source:i,select:function(i,s){var o=e(this);if(!h(e.trim(s.item.value),r.assignedTags)){if(n.maxTags>0&&r.assignedTags.length>=n.maxTags){throw new Error("Maximum tags allowed: "+n.maxTags)}else{var u=e.trim(s.item.value);var a=1;if(typeof n.onAdd=="function"){a=n.onAdd.call(this,u)}if(a||typeof a=="undefined"){r=e(t).tagHandler("addTag",u);if(n.updateURL!==""&&n.autoUpdate){e(t).tagHandler("saveTags")}if(typeof n.afterAdd=="function"){n.afterAdd.call(this,u)}}}o.focus()}o.val("");return false},minLength:n.minChars})};var o=function(t){var n=v(t,"opts");if(!n){return}var r=v(t,"tags");if(n.getURL!==""&&n.initLoad){e.ajax({url:n.getURL,cache:false,data:n.getData,dataType:"json",success:function(e){c(t,e)},error:function(e,t,r){g(e,{text:t,error:r});throw new Error(n.msgError)}})}else{c(t,n)}};var u=function(t){var n=v(t,"opts");if(!n){return}var r=v(t,"tags");var i=e(t).find(".tagInputField");if(n.allowEdit){e(i).keypress(e(t),f);e(i).keydown(e(t),l);e(t).click(function(){e(i).focus();e(i).trigger("focus")});e(i).focus(function(){if(e(i).val()===""&&n.autocomplete&&typeof e.fn.autocomplete=="function"&&n.initLoad&&r.availableTags.length>0){e(i).autocomplete("search","")}});e(t).delegate("li.tagItem, li.jqueryUiTagItem","click",e(t),a)}};var a=function(t){var n=t.data;var r=v(n,"opts");if(!r){return}var i=v(n,"tags");var s=e(this);var o=1;if(typeof r.onDelete=="function"){o=r.onDelete.call(this,e.trim(s.text()))}if(o){e(n).tagHandler("removeTag",s.text());if(r.updateURL!==""&&r.autoUpdate){e(n).tagHandler("saveTags")}}if(typeof r.afterDelete=="function"){r.afterDelete.call(this,e.trim(s.text()))}};var f=function(t){var n=t.data;var r=v(n,"opts");if(!r){return}var i=v(n,"tags");var s=t.keyCode||t.which;var o=e(this);if(s===13||s===44||s===9||s===r.delimiter.charCodeAt(0)){t.preventDefault();t.stopImmediatePropagation();if(o.val()!==""&&!h(e.trim(o.val()),i.assignedTags)){if(!r.allowAdd&&!h(e.trim(o.val()),i.availableTags)){alert(r.msgNoNewTag);return}if(r.maxTags>0&&i.assignedTags.length>=r.maxTags){alert("Maximum tags allowed: "+r.maxTags)}else{var u=e.trim(o.val());var a=1;if(typeof r.onAdd=="function"){a=r.onAdd.call(this,u)}if(a||typeof a=="undefined"){i=e(n).tagHandler("addTag",u);if(r.updateURL!==""&&r.autoUpdate){e(n).tagHandler("saveTags")}if(typeof r.afterAdd=="function"){r.afterAdd.call(this,u)}}}o.val("");o.focus()}}};var l=function(t){var n=t.data;var r=v(n,"opts");if(!r){return}var i=v(n,"tags");var s=t.keyCode||t.which;var o=e(this);if(s===9){t.preventDefault();t.stopImmediatePropagation()}if(t.which===8&&o.val()===""){var u=i.assignedTags.slice(-1)[0];if(typeof r.onDelete=="function"){r.onDelete.call(this,e.trim(u))}e(n).tagHandler("removeTag",u);if(r.updateURL!==""&&r.autoUpdate){e(n).tagHandler("saveTags")}if(typeof r.afterDelete=="function"){r.afterDelete.call(this,e.trim(u))}o.focus()}};var c=function(t,n){e(n.availableTags).each(function(n,r){e(t).tagHandler("addOption",r)});e(n.assignedTags).each(function(n,r){e(t).tagHandler("addTag",r)})};var h=function(e,t){var n=false;jQuery.each(t,function(t,r){if(r===e){n=true;return false}return true});return n};var p=function(e){e.availableTags=e.availableTags.sort();e.assignedTags=e.assignedTags.sort();e.originalTags=e.originalTags.sort();return e};var d=function(t,n,r){var i=e(t).data("tagHandlerState");if(!i){i={}}i[n]=r;e(t).data("tagHandlerState",i)};var v=function(t,n){var r=e(t).data("tagHandlerState");if(!r||r[n]==undefined){return null}return r[n]};var m=function(){return{allowEdit:true,allowAdd:true,assignedTags:[],autocomplete:false,autoUpdate:false,availableTags:[],className:"tagHandler",debug:false,delimiter:"",getData:{},getURL:"",initLoad:true,maxTags:0,minChars:0,msgNoNewTag:"You don't have permission to create a new tag.",msgError:"There was an error getting the tag list.",onAdd:{},onDelete:{},afterAdd:{},afterDelete:{},queryname:"q",sortTags:true,updateData:{},updateURL:"",jqueryTheme:false}};var g=function(t,n){if(n.debug&&window.console&&window.console.log){window.console.log(t);window.console.log(n);window.console.log(e.fn.tagHandler.defaults)}};var y=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})};jQuery.fn.tagHandler=function(e){if(typeof e=="string"&&t[e]){return t[e].apply(this,Array.prototype.slice.call(arguments,1))}else{return n.apply(this,arguments)}}})(jQuery)